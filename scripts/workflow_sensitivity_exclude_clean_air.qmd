---
title: "Sensitivity analysis_exclude clean air"
author: "Asbjørn Kloppenborg"
format: html
editor: visual
---



```{r, setup}
#| echo: false
#| message: false
#| warning: false
library(here)
library(rprojroot)
library(tidyverse)
library(gt)

root <- rprojroot::find_root(rprojroot::is_rstudio_project)
knitr::opts_knit$set(root.dir = here::here())

source(here("scripts", "functions_main_analysis.R"))

# Load merged dataset
load(here::here("clean_data", "all_data_main_analysis.rda"))
```

#Prepare data before plotting figure 1

```{r, prepare figure 1}

figure1_long <- all_data |> select(timestamp_rounded_5min, source, sensor, SPS30_PM2.5, PM25_dusttrak, PM1_SMPS_SPS30, PM25_APS_valid) %>%
  mutate(
    SMPS_APS = PM1_SMPS_SPS30 + PM25_APS_valid,
    Dusttrak = PM25_dusttrak * 1000
  ) %>%
  pivot_longer(
    cols = c(SPS30_PM2.5, Dusttrak, SMPS_APS),
    names_to = "instrument",
    values_to = "PM25"
  ) %>%
  mutate(
    instrument = case_when(
      instrument == "SPS30_PM2.5" ~paste("Sensor", sensor),
      TRUE ~ instrument
    ),
    instrument = factor(instrument),
    instrument = fct_recode(
      instrument,
      "SMPS + APS" = "SMPS_APS",
      "DustTrak"   = "Dusttrak"
    ),
    instrument = fct_relevel(
      instrument,
      "SMPS + APS",
      "DustTrak"
    )
  )
```

#Plot figure 1

```{r, figure 1}

#| label: figure1

# figure1 <- ggplot(figure1_long, aes(x = timestamp_rounded_5min, y = PM25, color = factor(instrument))) +
#   geom_line() +
#   ylim(0, 100) +
#   facet_wrap(~source, scales = "free") +
#   theme_minimal() +
#   labs(
#     title = "PM2.5 concentrations over time",
#     y = "PM2.5 (µg/m³)",
#     color = "Instrument"
#   )+
  # scale_color_manual(
  #   values = c(
  #     "SMPS_APS" = "red",
  #     "Dusttrak" = "green"
  #   ),
  #   guide = "legend"
  #   )


figure1 <- ggplot(figure1_long,
  aes(x = timestamp_rounded_5min, y = PM25, group = instrument, color = instrument, alpha = instrument,
    linewidth = instrument)
) +
  geom_line() +
  ylim(0, 100) +
  facet_wrap(~source, scales = "free") +
  theme_minimal() +
  labs(
    title = "PM2.5 concentrations over time",
    y = "PM2.5 (µg/m³)",
    color = "Instrument"
  ) +
  scale_color_manual(values = c(
  "DustTrak" = "#E69F00",   # orange
  "SMPS + APS" = "#56B4E9",   # sky blue
    "Sensor 1" = "grey70",
    "Sensor 2" = "grey70",
    "Sensor 3" = "grey70",
    "Sensor 4" = "grey70",
    "Sensor 5" = "grey70",
    "Sensor 6" = "grey70",
    "Sensor 7" = "grey70",
    "Sensor 8" = "grey70",
    "Sensor 9" = "grey70"
  )) +
  scale_alpha_manual(values = c(
    "DustTrak" = 1,
    "SMPS + APS" = 1,
    "Sensor 1" = 0.3,
    "Sensor 2" = 0.3,
    "Sensor 3" = 0.3,
    "Sensor 4" = 0.3,
    "Sensor 5" = 0.3,
    "Sensor 6" = 0.3,
    "Sensor 7" = 0.3,
    "Sensor 8" = 0.3,
    "Sensor 9" = 0.3
  )) +
  scale_linewidth_manual(values = c(
    "DustTrak" = 1,
    "SMPS + APS" = 1,
    "Sensor 1" = 0.3,
    "Sensor 2" = 0.3,
    "Sensor 3" = 0.3,
    "Sensor 4" = 0.3,
    "Sensor 5" = 0.3,
    "Sensor 6" = 0.3,
    "Sensor 7" = 0.3,
    "Sensor 8" = 0.3,
    "Sensor 9" = 0.3
  )) +
  guides(alpha = "none", linewidth = "none")


#Print figure 1
figure1

#save figure 1
ggsave("plots/figure1.png", plot = figure1, width = 8, height = 6, dpi = 300)
```

---

## 1. SMPS + APS as Reference, Raw SPS30

```{r, make-reference SMPS + APS raw sensitivity}
all_data_ref <- make_reference_pm25(
  all_data,
  ref_col = "PM2.5_ref",
  ref_measurements = PM1_SMPS_SPS30 + PM25_APS_valid,
  reference = "SMPS + APS"
) |> filter(source != "clean_air")

all_data_ref |> 
  group_by(source) |> 
  summarise(across(PM2.5_ref, list(min=min, max=max, mean=mean, median=median)), n=n())
```

```{r, prepare SMPS + APS raw sensitivity}
#| fig-cap: "Data preparation and log-transform scaffolding (sensitivity analysis)."
dat <- prepare_for_modeling(all_data_ref, ref_col = "PM2.5_ref")
glimpse(dat)
```

```{r, loso-sensor SMPS + APS raw sensitivity}
#| fig-cap: "Leave-one-sensor-out results (sensitivity, PM2.5 ≤ 50 µg/m³)."
loso_sens_SMPS_APS_raw <- loso_by_sensor(dat, ref_col = "PM2.5_ref", method = "raw")
loso_sens_SMPS_APS_raw$per_sensor %>% arrange(desc(n))
```

```{r, loso-sensor-plots SMPS + APS raw sensitivity}
p_scatter <- plot_scatter(loso_sens_SMPS_APS_raw$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="LOSO by Sensor (Raw SPS30 vs Reference, sensitivity)",
                          facet_factor="holdout_sensor")

p_resid <- plot_residuals_vs_rh(loso_sens_SMPS_APS_raw$predictions,
                                ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                title="LOSO by Sensor: Residuals vs RH (sensitivity)",
                                facet_factor="holdout_sensor")

p_ba <- plot_bland_altman(loso_sens_SMPS_APS_raw$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="LOSO by Sensor: Bland–Altman (sensitivity)",
                          facet_factor="holdout_sensor")

p_scatter; p_resid; p_ba
```

```{r, loso-source SMPS + APS raw sensitivity}
#| fig-cap: "Leave-one-source-out results (sensitivity, PM2.5 ≤ 50 µg/m³)."
loso_src_SMPS_APS_raw <- loso_by_source(dat, ref_col="PM2.5_ref", method="raw")
loso_src_SMPS_APS_raw$per_source %>% arrange(desc(n))
```

```{r, loso-source-plots SMPS + APS raw sensitivity}
p_scatter_src <- plot_scatter(loso_src_SMPS_APS_raw$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="LOSO by Source (Raw SPS30 vs Reference, sensitivity)",
                              facet_factor="source")

p_resid_src <- plot_residuals_vs_rh(loso_src_SMPS_APS_raw$predictions,
                                    ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                    title="LOSO by Source: Residuals vs RH (sensitivity)",
                                    facet_factor="source")

p_ba_src <- plot_bland_altman(loso_src_SMPS_APS_raw$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="LOSO by Source: Bland–Altman (sensitivity)",
                              facet_factor="source")

p_scatter_src; p_resid_src; p_ba_src
```

```{r, summary-tables SMPS + APS raw sensitivity}
#| tbl-cap: "Performance summaries (sensitivity, PM2.5 ≤ 50 µg/m³)."
loso_sens_SMPS_APS_raw$per_sensor %>%
  select(holdout_sensor, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)

loso_src_SMPS_APS_raw$per_source %>%
  select(holdout_source, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)
```

---

## 2. SMPS + APS as Reference, Calibrated SPS30 (lm)

```{r, make-reference SMPS + APS lm sensitivity}
all_data_ref <- make_reference_pm25(
  all_data,
  ref_col = "PM2.5_ref",
  ref_measurements = PM1_SMPS_SPS30 + PM25_APS_valid,
  reference = "SMPS + APS"
) |> filter(PM2.5_ref <= 50)
```

```{r, prepare SMPS + APS lm sensitivity}
dat <- prepare_for_modeling(all_data_ref, ref_col="PM2.5_ref")
```

```{r, loso-sensor SMPS + APS lm sensitivity}
loso_sens_SMPS_APS_lm <- loso_by_sensor(dat, ref_col="PM2.5_ref", method="lm")
loso_sens_SMPS_APS_lm$per_sensor %>% arrange(desc(n))
```

```{r, loso-sensor-plots SMPS + APS lm sensitivity}
p_scatter <- plot_scatter(loso_sens_SMPS_APS_lm$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="LOSO by Sensor (Calibrated SPS30 vs Reference, sensitivity)",
                          facet_factor="holdout_sensor")

p_resid <- plot_residuals_vs_rh(loso_sens_SMPS_APS_lm$predictions,
                                ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                title="Residuals vs RH (sensitivity)",
                                facet_factor="holdout_sensor")

p_ba <- plot_bland_altman(loso_sens_SMPS_APS_lm$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="Bland–Altman (sensitivity)",
                          facet_factor="holdout_sensor")

p_scatter; p_resid; p_ba
```

```{r, loso-source SMPS + APS lm sensitivity}
loso_src_SMPS_APS_lm <- loso_by_source(dat, ref_col="PM2.5_ref", method="lm")
loso_src_SMPS_APS_lm$per_source %>% arrange(desc(n))
```

```{r, loso-source-plots SMPS + APS lm sensitivity}
p_scatter_src <- plot_scatter(loso_src_SMPS_APS_lm$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="LOSO by Source (Calibrated SPS30 vs Reference, sensitivity)",
                              facet_factor="source")

p_resid_src <- plot_residuals_vs_rh(loso_src_SMPS_APS_lm$predictions,
                                    ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                    title="Residuals vs RH (sensitivity)",
                                    facet_factor="source")

p_ba_src <- plot_bland_altman(loso_src_SMPS_APS_lm$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="Bland–Altman (sensitivity)",
                              facet_factor="source")

p_scatter_src; p_resid_src; p_ba_src
```

```{r, summary-tables SMPS + APS lm sensitivity}
loso_sens_SMPS_APS_lm$per_sensor %>%
  select(holdout_sensor, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)

loso_src_SMPS_APS_lm$per_source %>%
  select(holdout_source, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)
```

---

## 3. DustTrak as Reference, Raw SPS30

```{r, make-reference dusttrak raw sensitivity}
all_data_ref <- make_reference_pm25(all_data, ref_col = "PM2.5_ref", 
                                    ref_measurements = PM25_dusttrak * 1000,
                                    reference = "Dusttrak" ) |> 
  filter(PM2.5_ref <= 50)
```

```{r, prepare dusttrak raw sensitivity}
dat <- prepare_for_modeling(all_data_ref, ref_col = "PM2.5_ref")
```

```{r, loso-sensor dusttrak raw sensitivity}
loso_sens_dusttrak_raw <- loso_by_sensor(dat, ref_col = "PM2.5_ref", method = "raw")
loso_sens_dusttrak_raw$per_sensor %>% arrange(desc(n))
```

```{r, loso-sensor-plots dusttrak raw sensitivity}
p_scatter <- plot_scatter(loso_sens_dusttrak_raw$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="LOSO by Sensor (Raw SPS30 vs DustTrak, sensitivity)",
                          facet_factor="holdout_sensor")

p_resid <- plot_residuals_vs_rh(loso_sens_dusttrak_raw$predictions,
                                ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                title="Residuals vs RH (sensitivity)",
                                facet_factor="holdout_sensor")

p_ba <- plot_bland_altman(loso_sens_dusttrak_raw$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="Bland–Altman (sensitivity)",
                          facet_factor="holdout_sensor")

p_scatter; p_resid; p_ba
```

```{r, loso-source dusttrak raw sensitivity}
loso_src_dusttrak_raw <- loso_by_source(dat, ref_col = "PM2.5_ref", method = "raw")
loso_src_dusttrak_raw$per_source %>% arrange(desc(n))
```

```{r, loso-source-plots dusttrak raw sensitivity}
p_scatter_src <- plot_scatter(loso_src_dusttrak_raw$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="LOSO by Source (Raw SPS30 vs DustTrak, sensitivity)",
                              facet_factor="source")

p_resid_src <- plot_residuals_vs_rh(loso_src_dusttrak_raw$predictions,
                                    ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                    title="Residuals vs RH (sensitivity)",
                                    facet_factor="source")

p_ba_src <- plot_bland_altman(loso_src_dusttrak_raw$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="Bland–Altman (sensitivity)",
                              facet_factor="source")

p_scatter_src; p_resid_src; p_ba_src
```

```{r, summary-tables dusttrak raw sensitivity}
loso_sens_dusttrak_raw$per_sensor %>%
  select(holdout_sensor, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)

loso_src_dusttrak_raw$per_source %>%
  select(holdout_source, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)
```

---

## 4. DustTrak as Reference, Calibrated SPS30 (lm)

```{r, make-reference dusttrak lm sensitivity}
all_data_ref <- make_reference_pm25(all_data, ref_col = "PM2.5_ref", 
                                    ref_measurements = PM25_dusttrak * 1000,
                                    reference = "Dusttrak") |> 
  filter(PM2.5_ref <= 50)
```

```{r, prepare dusttrak lm sensitivity}
dat <- prepare_for_modeling(all_data_ref, ref_col = "PM2.5_ref")
```

```{r, loso-sensor dusttrak lm sensitivity}
loso_sens_dusttrak_lm <- loso_by_sensor(dat, ref_col = "PM2.5_ref", method = "lm")
loso_sens_dusttrak_lm$per_sensor %>% arrange(desc(n))
```

```{r, loso-sensor-plots dusttrak lm sensitivity}
p_scatter <- plot_scatter(loso_sens_dusttrak_lm$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="LOSO by Sensor (Calibrated SPS30 vs DustTrak, sensitivity)",
                          facet_factor="holdout_sensor")

p_resid <- plot_residuals_vs_rh(loso_sens_dusttrak_lm$predictions,
                                ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                title="Residuals vs RH (sensitivity)",
                                facet_factor="holdout_sensor")

p_ba <- plot_bland_altman(loso_sens_dusttrak_lm$predictions,
                          ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                          title="Bland–Altman (sensitivity)",
                          facet_factor="holdout_sensor")

p_scatter; p_resid; p_ba
```

```{r, loso-source dusttrak lm sensitivity}
loso_src_dusttrak_lm <- loso_by_source(dat, ref_col = "PM2.5_ref", method = "lm")
loso_src_dusttrak_lm$per_source %>% arrange(desc(n))
```

```{r, loso-source-plots dusttrak lm sensitivity}
p_scatter_src <- plot_scatter(loso_src_dusttrak_lm$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="LOSO by Source (Calibrated SPS30 vs DustTrak, sensitivity)",
                              facet_factor="source")

p_resid_src <- plot_residuals_vs_rh(loso_src_dusttrak_lm$predictions,
                                    ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                                    title="Residuals vs RH (sensitivity)",
                                    facet_factor="source")

p_ba_src <- plot_bland_altman(loso_src_dusttrak_lm$predictions,
                              ref_col="PM2.5_ref", pred_col="PM2.5_pred",
                              title="Bland–Altman (sensitivity)",
                              facet_factor="source")

p_scatter_src; p_resid_src; p_ba_src
```

```{r, summary-tables dusttrak lm sensitivity}
loso_sens_dusttrak_lm$per_sensor %>%
  select(holdout_sensor, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)

loso_src_dusttrak_lm$per_source %>%
  select(holdout_source, n, R, R2, MAE, RMSE, 
         mpe, MAPE, MeanError, LoA_Low, LoA_High)

```


```{r, prepare table 1s}
# #inspect the number of observations per sensor per exposure source:
# table1s_data_clean <- all_data |> count(sensor, source) |>
#   mutate(
#     # hours = n*5/60,
#     source = case_when(
#       source == "candles_high_RH"   ~ "Candles (high RH)",
#       source == "cooking_high_RH"   ~ "Cooking (high RH)",
#       source == "candles"           ~ "Candles",
#       source == "cooking"           ~ "Cooking",
#       source == "cigarette"         ~ "Cigarette",
#       source == "clean_air"         ~ "Clean air",
#       TRUE ~ source
#     )) 
```

```{r, table 1s output}
# Build grouped GT table
# table1s_gt <- table1s_data_clean |>
#   gt(groupname_col = "source") |>
#   tab_header(
#     title = "Performance metrics for SPS30 sensor PM₂.₅ concentrations",
#     subtitle = "Against reference instruments (SMPS + APS, DustTrak), stratified by source type and calibration method"
#   ) |>
#   cols_label(
#     sensor = "Sensor ID",
#     source = "Source",
#     n = "Total observations"
#   ) |>
#   tab_style(
#     style = cell_text(weight = "bold"),
#     locations = cells_row_groups()
#   )
# 
# #To view in RStudio
# table1s_gt
# 
# # To save as Word/HTML/PDF if needed
# gtsave(table1s_gt, "tables/sensitivity/table1s.docx", overwrite = TRUE)   # Word
```


```{r, prepare table 2s}
#| tbl-cap: "Performance summaries across LOSO schemes."

loso_src_SMPS_APS_raw_table2s <- loso_src_SMPS_APS_raw$per_source |> 
  mutate(method = "Uncalibrated",
          reference = "SMPS + APS")

loso_src_SMPS_APS_lm_table2s <- loso_src_SMPS_APS_lm$per_source |> 
  mutate(method = "Calibrated",
          reference = "SMPS + APS")

loso_src_dusttrak_raw_table2s <- loso_src_dusttrak_raw$per_source |> 
  mutate(method = "Uncalibrated",
          reference = "Dusttrak")

loso_src_dusttrak_lm_table2s <- loso_src_dusttrak_lm$per_source |> 
  mutate(method = "Calibrated",
          reference = "Dusttrak")

table2s_data <- bind_rows(
  loso_src_SMPS_APS_raw_table2s,
  loso_src_SMPS_APS_lm_table2s,
  loso_src_dusttrak_raw_table2s,
  loso_src_dusttrak_lm_table2s
)

```

```{r, table 2s output}}
# Clean up labels and rounding
table2s_data_clean <- table2s_data |>
  mutate(
    holdout_source = case_when(
      holdout_source == "candles_high_RH"   ~ "Candles (high RH)",
      holdout_source == "cooking_high_RH"   ~ "Cooking (high RH)",
      holdout_source == "candles"           ~ "Candles",
      holdout_source == "cooking"           ~ "Cooking",
      holdout_source == "cigarette"         ~ "Cigarette",
      holdout_source == "clean_air"         ~ "Clean air",
      TRUE ~ holdout_source
    ),
    R        = round(R, 2),
    MAE      = round(MAE, 1),
    RMSE     = round(RMSE, 1),
    MeanError = round(MeanError, 1),
    LoA_Low  = round(LoA_Low, 1),
    LoA_High = round(LoA_High, 1)
  ) |>
  select(
    Source = holdout_source,
    Reference = reference,
    Method = method,
    R, MAE, RMSE,
    `Mean Error` = MeanError,
    `LoA Low` = LoA_Low,
    `LoA High` = LoA_High
  ) |>
  arrange(Source, Reference, Method)

# Build grouped GT table
table2s_gt <- table2s_data_clean |>
  gt(groupname_col = "Source") |>
  tab_header(
    title = "Performance metrics for SPS30 sensor PM₂.₅ concentrations",
    subtitle = "Against reference instruments (SMPS + APS, DustTrak), stratified by source type and calibration method"
  ) |>
  cols_label(
    Reference = "Reference",
    Method = "Method",
    R = "R",
    MAE = "MAE (µg/m³)",
    RMSE = "RMSE (µg/m³)",
    `Mean Error` = "Mean Error (µg/m³)",
    `LoA Low` = "LoA Low (µg/m³)",
    `LoA High` = "LoA High (µg/m³)"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  )


# To view in RStudio
table2s_gt

# To save as Word/HTML/PDF if needed
gtsave(table2s_gt, "tables/sensitivity_exclude_clean/table2s.docx", overwrite = TRUE)   # Word
# gtsave(table2_gt, "table2.html")   # HTML
# gtsave(table2_gt, "table2.png")    # Image
```

```{r, prepare table 3s}
#| tbl-cap: "Performance summaries across LOSO schemes."

loso_sens_SMPS_APS_raw_table3s <- loso_sens_SMPS_APS_raw$per_sensor |> 
  mutate(method = "Uncalibrated",
          reference = "SMPS + APS")

loso_sens_SMPS_APS_lm_table3s <- loso_sens_SMPS_APS_lm$per_sensor |> 
  mutate(method = "Calibrated",
          reference = "SMPS + APS")

loso_sens_dusttrak_raw_table3s <- loso_sens_dusttrak_raw$per_sensor |> 
  mutate(method = "Uncalibrated",
          reference = "Dusttrak")

loso_sens_dusttrak_lm_table3s <- loso_sens_dusttrak_lm$per_sensor |> 
  mutate(method = "Calibrated",
          reference = "Dusttrak")

table3s_data <- bind_rows(
  loso_sens_SMPS_APS_raw_table3s,
  loso_sens_SMPS_APS_lm_table3s,
  loso_sens_dusttrak_raw_table3s,
  loso_sens_dusttrak_lm_table3s
)

```

```{r, table 3s output}}
# Clean up labels and rounding
table3s_data_clean <- table3s_data |>
  mutate(
    # holdout_source = case_when(
    #   holdout_source == "candles_high_RH"   ~ "Candles (high RH)",
    #   holdout_source == "cooking_high_RH"   ~ "Cooking (high RH)",
    #   holdout_source == "candles"           ~ "Candles",
    #   holdout_source == "cooking"           ~ "Cooking",
    #   holdout_source == "cigarette"         ~ "Cigarette",
    #   holdout_source == "clean_air"         ~ "Clean air",
    #   TRUE ~ holdout_source
    # ),
    R        = round(R, 2),
    MAE      = round(MAE, 1),
    RMSE     = round(RMSE, 1),
    MeanError = round(MeanError, 1),
    LoA_Low  = round(LoA_Low, 1),
    LoA_High = round(LoA_High, 1)
  ) |>
  select(
    Sensor = holdout_sensor,
    Reference = reference,
    Method = method,
    R, MAE, RMSE,
    `Mean Error` = MeanError,
    `LoA Low` = LoA_Low,
    `LoA High` = LoA_High
  ) |>
  arrange(Sensor, Reference, Method)

# Build grouped GT table
table3s_gt <- table3s_data_clean |>
  gt(groupname_col = "Sensor") |>
  tab_header(
    title = "Performance metrics for SPS30 sensor PM₂.₅ concentrations",
    subtitle = "Against reference instruments (SMPS + APS, DustTrak), stratified by sensor node and calibration method"
  ) |>
  cols_label(
    Reference = "Reference",
    Method = "Method",
    R = "R",
    MAE = "MAE (µg/m³)",
    RMSE = "RMSE (µg/m³)",
    `Mean Error` = "Mean Error (µg/m³)",
    `LoA Low` = "LoA Low (µg/m³)",
    `LoA High` = "LoA High (µg/m³)"
  ) |>
  tab_style(
    style = cell_text(weight = "bold"),
    locations = cells_row_groups()
  )


# To view in RStudio
table3s_gt

# To save as Word/HTML/PDF if needed
gtsave(table3s_gt, "tables/sensitivity_exclude_clean/table3s.docx", overwrite = TRUE)   # Word
```
